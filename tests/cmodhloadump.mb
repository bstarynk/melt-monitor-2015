# file cmodhloadump.mb -*- mode: indented-text; indent-tabs-mode: nil -*-


^global !ldstatkind_en (
  ^* descr type
  ^* comment "type for load state kind"
  ^* type enum
  ^* enum [
    ^global !lstk_empty (
      ^* descr enumerator
      ^* comment "for empty load element"
    )
    ^global !lstk_mark (
      ^* descr enumerator
      ^* comment "for marking load element"
    )
    ^global !lstk_int (
      ^* descr enumerator
      ^* comment "for int load element"
    )
    ^global !lstk_dbl (
      ^* descr enumerator
      ^* comment "for double load element"
    )
    ^global !lstk_val (
      ^* descr enumerator
      ^* comment "for value load element"
    )
  ]
)

^global !cptr_t (
  ^* descr type
  ^* c_code "const void*"
  ^* comment "raw C pointer type"
)

^global !cfile_t (
  ^* descr type
  ^* c_code "FILE*"
  ^* comment "C <stdio.h> file handle pointer"
)

^global !int32_t (
  ^* descr type
  ^* c_code "int32_t"
  ^* comment "signed 32 bits integer type"
)

^global !ldstatelem_ty (
  ^* descr type
  ^* comment "type for load state element"
  ^* type struct
  ^* struct [
    ^global !lst_kind (
      ^* descr field
      ^* comment "give the kind of a loader element"
      ^* type ldstatkind_en
    )
    ^global ?ldstatelem_ty (
      ^* descr union
      ^* comment "the anonymous union of a loader element"
      ^* union [
        ^global !lst_ptr (
          ^* descr field
          ^* comment "raw pointer field in loader stack"
          ^* type cptr_t
         )
        ^global !lst_mark (
          ^* descr field
          ^* comment "mark field  in loader stack"
          ^* type uint32_t
         )
        ^global !lst_int (
          ^* descr field
          ^* comment "int field  in loader stack"
          ^* type int
         )
        ^global !lst_dbl (
          ^* descr field
          ^* comment "double field  in loader stack"
          ^* type double
         )
        ^global !lst_val (
          ^* descr field
          ^* comment "value field  in loader stack"
          ^* type value
         )
      ]
    )
  ]
)

^global !itemhashedset_ty (
  ^* descr type
  ^* comment "type of hashed set of items"
  ^* type struct
  ^* extend countedata_ty
  ^* struct [
    ^global !hset_items (
        ^* comment "the field giving the items hashtable in item hashed set"
        ^* descr field
        ^* type %flexible_array(item)
      )
  ]
)

^global !loader_ty  (
  ^* descr type
  ^* comment "type for loader"
  ^* type struct
  ^* extend hashedvalue_ty
  ^* struct [
    ^global !ld_stacktop (
          ^* descr field
          ^* comment "loader stack top index"
          ^* type int32_t
          )
    ^global !ld_prevmark (
          ^* descr field
          ^* comment "loader stack previous mark index"
          ^* type int32_t
          )
    ^global !ld_stackarr (
          ^* descr field
          ^* comment "loader stack array"
          ^* type %pointer(ldstatelem_ty)
          )
    ^global !ld_hsetitems (
          ^* descr field
          ^* comment "loader stack hashed set of items"
          ^* type %pointer(itemhashedset_ty)
          )
    ^global !ld_magic (
          ^* descr field
          ^* comment "loader stack magic, always MOM_LOADER_MAGIC"
          ^* type uint32_t
          )
    ^global !ld_file (
          ^* descr field
          ^* comment "loader file"
          ^* type cfile_t
          )
    ^global !ld_pathstr (
          ^* descr field
          ^* comment "loader path string"
          ^* type %pointer(boxstring_ty)
          )
    ]
)

^global !loaderptr_t (
  ^* comment "type of pointer to loader"
  ^* descr type
  ^* type %pointer(loader_ty)
)

^global !loaderstatelemptr_t (
  ^* comment "type of pointer to loader state element"
  ^* descr type
  ^* type %pointer(ldstatelem_ty)
)

^global !ldf (
  ^* descr formal
  ^* type loaderptr_t
  ^* comment "formal for loader"
)

^global !ldelems (
  ^* descr formal
  ^* type loaderstatelemptr_t
  ^* comment "formal for loader state array"
)

^global !ldsz (
  ^* descr formal
  ^* type uint32_t
  ^* comment "formal for loader state size"
)

^item signature_loader_caret (
   ^* comment "signature: loaderptr item -> unit for carets in loadfile"
   ^* descr signature
   ^* formals [ itm0 ldf ]
   ^* result unit
   )
   
^item signature_loader_paren (
   ^* comment "signature: loaderptr item -> unit for carets in loadfile"
   ^* descr signature
   ^* formals [ itm0 ldf ldelems ldsz ]
   ^* result unit
   )
   
^global !loader_module (
   ^* comment "our loader_module"
   ^* descr module
   ^* declare [ ]
   ^* module [
     ldstatkind_en
     ldstatelem_ty
     loader_ty
     signature_loader_caret
     signature_loader_paren
   ]
 )
 
^display "our loader_module:" loader_module
